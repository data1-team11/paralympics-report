<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Team 11 - (Swim) water quality of Amsterdam canals</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Team 11</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./water.html" rel="" target="" aria-current="page">
 <span class="menu-text">Water</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./energy.html" rel="" target="">
 <span class="menu-text">Energy</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./airbnb_listings_JJ.html" rel="" target="">
 <span class="menu-text">Housing</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./transport.html" rel="" target="">
 <span class="menu-text">Transport</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
    <a href="https://github.com/data1-team11/paralympics-report" rel="" title="" class="quarto-navigation-tool px-1" aria-label=""><i class="bi bi-github"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#datasets-found" id="toc-datasets-found" class="nav-link active" data-scroll-target="#datasets-found">Datasets found</a>
  <ul class="collapse">
  <li><a href="#sewage-overflows" id="toc-sewage-overflows" class="nav-link" data-scroll-target="#sewage-overflows">Sewage overflows</a></li>
  <li><a href="#canal-traffic" id="toc-canal-traffic" class="nav-link" data-scroll-target="#canal-traffic">Canal Traffic</a></li>
  </ul></li>
  <li><a href="#choosing-a-route" id="toc-choosing-a-route" class="nav-link" data-scroll-target="#choosing-a-route">Choosing a route</a>
  <ul class="collapse">
  <li><a href="#canal-traffic-1" id="toc-canal-traffic-1" class="nav-link" data-scroll-target="#canal-traffic-1">Canal traffic</a></li>
  <li><a href="#amsterdam-city-swim" id="toc-amsterdam-city-swim" class="nav-link" data-scroll-target="#amsterdam-city-swim">Amsterdam City Swim</a></li>
  <li><a href="#identifying-potential-routes" id="toc-identifying-potential-routes" class="nav-link" data-scroll-target="#identifying-potential-routes">Identifying potential routes</a></li>
  </ul></li>
  <li><a href="#recommendations" id="toc-recommendations" class="nav-link" data-scroll-target="#recommendations">Recommendations</a></li>
  <li><a href="#auto-generated-routes" id="toc-auto-generated-routes" class="nav-link" data-scroll-target="#auto-generated-routes">Auto-generated routes</a>
  <ul class="collapse">
  <li><a href="#finding-potential-routes" id="toc-finding-potential-routes" class="nav-link" data-scroll-target="#finding-potential-routes">Finding potential routes</a></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.dev/data1-team11/paralympics-report/blob/main/water.ipynb" class="toc-action">Edit this page</a></p><p><a href="https://github.com/data1-team11/paralympics-report/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">(Swim) water quality of Amsterdam canals</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>To host an open water swim meet in the canals of Amsterdam, we must first ensure that the water quality is good enough for swimming. Unfortunately, only official bathing sites in the Amsterdam canals are monitored for water quality. <span class="citation" data-cites="waternet_swimming_nodate">(<a href="#ref-waternet_swimming_nodate" role="doc-biblioref">Waternet n.d.</a>)</span> Thus, there is limited data available.</p>
<p>We do know that there are various factors that affect the quality of water, such as sewage overflows, water currents, temperature and more <span class="citation" data-cites="van_den_tillaart_swim_2017">(<a href="#ref-van_den_tillaart_swim_2017" role="doc-biblioref">Tillaart 2017</a>)</span>. If we had data sampled at appropriate locations and sufficient background knowledge, we would use a model to estimate water pollution levels and how they are affected by weather and canal traffic. For now, we will use the available data for some basic analysis.</p>
<section id="datasets-found" class="level2">
<h2 class="anchored" data-anchor-id="datasets-found">Datasets found</h2>
<p>Here is the list of <strong>datasets</strong> we have identified with regards to water pollution levels, along with the <strong>relevant available sources</strong> (if existant) of information and their <strong>formats</strong>.</p>
<table class="table">
<colgroup>
<col style="width: 5%">
<col style="width: 20%">
<col style="width: 40%">
<col style="width: 15%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">#</th>
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Explanation</th>
<th style="text-align: left;">Source</th>
<th style="text-align: left;">Format</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1.</td>
<td style="text-align: left;">Pollution levels in Herensgracht and Prinsengracht</td>
<td style="text-align: left;">Chemical composition of the water</td>
<td style="text-align: left;"><a href="https://www.rivm.nl/publicaties/microbiologische-kwaliteit-van-grachtenwater-in-amsterdam">Study</a></td>
<td style="text-align: left;">Journal</td>
</tr>
<tr class="even">
<td style="text-align: left;">2.</td>
<td style="text-align: left;">Pollution levels in swimming locations</td>
<td style="text-align: left;">Chemical levels in swimming locations in 2019 with interpreted data</td>
<td style="text-align: left;"><a href="https://onderzoek.amsterdam.nl/dataset/water-in-amsterdam">Dataset</a></td>
<td style="text-align: left;">Excel</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3.</td>
<td style="text-align: left;">Places with sensors available.</td>
<td style="text-align: left;">&nbsp;</td>
<td style="text-align: left;">&nbsp;</td>
<td style="text-align: left;">&nbsp;</td>
</tr>
<tr class="even">
<td style="text-align: left;">4.</td>
<td style="text-align: left;">Historical data for water quality.</td>
<td style="text-align: left;">&nbsp;</td>
<td style="text-align: left;">&nbsp;</td>
<td style="text-align: left;">&nbsp;</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5.</td>
<td style="text-align: left;">Sewage overflows</td>
<td style="text-align: left;">Used Python script to convert file to Geojson.</td>
<td style="text-align: left;"><a href="https://data.overheid.nl/dataset/xnhveaeyheww2w#panel-resources">Dataset</a></td>
<td style="text-align: left;">JSON</td>
</tr>
<tr class="even">
<td style="text-align: left;">6.</td>
<td style="text-align: left;">Canal traffic</td>
<td style="text-align: left;">Traffic densities of canals</td>
<td style="text-align: left;"><a href="https://www.cvs-congres.nl/cvspdfdocs_2013/cvs13_046.pdf">Report</a></td>
<td style="text-align: left;">Image</td>
</tr>
</tbody>
</table>
<section id="sewage-overflows" class="level3">
<h3 class="anchored" data-anchor-id="sewage-overflows">Sewage overflows</h3>
<p>Since Amsterdam uses a combined sewage system, sewage overflows are a major source of water pollution after heavy rain. <span class="citation" data-cites="van_den_tillaart_swim_2017">(<a href="#ref-van_den_tillaart_swim_2017" role="doc-biblioref">Tillaart 2017</a>)</span> We can see if there areas without sewage overflow points in the canals.</p>
<p>The Waternet sewerage network data is available on <a href="https://data.overheid.nl/dataset/xnhveaeyheww2w">Overheid.nl</a>. Unfortunately, the download link for the WFS data returned a 404 error. Instead, we used the provided API to retrieve the sewage nodes, then saved it to <a href="./data/sewer_nodes.geojson">sewer_nodes.geojson</a>. We then filtered the data to get the sewage overflow nodes and saved it to <a href="./data/sewage_overflow_nodes.geojson">sewage_overflow_nodes.geojson</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyproj <span class="im">import</span> Transformer</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>FILENAME_SEWER_NODES <span class="op">=</span> <span class="st">"data/sewer_nodes.geojson"</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>FILENAME_SEWAGE_OVERFLOW_NODES <span class="op">=</span> <span class="st">"data/sewage_overflow_nodes.geojson"</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>URL_SEWER_NODES <span class="op">=</span> (<span class="st">"https://api.data.amsterdam.nl/v1/leidingeninfrastructuur/"</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"waternet_rioolknopen/?page_size=1000"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>SEWAGE_OVERFLOW_TYPES <span class="op">=</span> [</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Uitlaat gemengde overstort"</span>,  <span class="co"># Mixed overflow</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Uitlaat vuilwater nooduitlaat"</span>,  <span class="co"># Black water emergency outlet</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"(Externe) overstortput"</span>,  <span class="co"># (External) overflow</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Overstort met signalering"</span>,  <span class="co"># Overflow with signaling</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Interne overstortput"</span>,  <span class="co"># Internal overflow</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Nooduitlaat met signalering"</span>  <span class="co"># Emergency overflow with signaling</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_sewer_nodes(url, geojson_filename, is_test_run<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Return sewer nodes as geodataframe, read from the GeoJSON file.</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="co">    If file does not exist, retrieve the data from the API and save results to</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="co">    the GeoJSON file. If this is a test run and the API is called, only partial</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="co">    results will be retrieved from the API.</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">        url: API endpoint for sewage networks data</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="co">        geojson_filename: file containing (or will contain) the saved data</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="co">        is_test_run: if True, limit number of API requests made (for debugging)</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(geojson_filename):</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Sewer nodes data has already been parsed to GeoJSON in '</span><span class="sc">{}</span><span class="st">'"</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>              .<span class="bu">format</span>(geojson_filename))</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.read_file(geojson_filename)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>((<span class="st">"Sewer nodes GeoJSON file does not exist. "</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>               <span class="st">"Requesting data from API</span><span class="sc">{}</span><span class="st">"</span>).<span class="bu">format</span>(url))</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        geojson_data <span class="op">=</span> retrieve_sewer_nodes_data_from_api(url, is_test_run)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Save data for future use</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(geojson_filename, <span class="st">"a+"</span>, encoding<span class="op">=</span><span class="st">'utf-8'</span>) <span class="im">as</span> outfile:</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>            json.dump(geojson_data, outfile)</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Sewer nodes data saved to file '</span><span class="sc">{}</span><span class="st">'"</span>.<span class="bu">format</span>(geojson_filename))</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        gdf <span class="op">=</span> gpd.GeoDataFrame.from_features(geojson_data[<span class="st">'features'</span>])</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> retrieve_sewer_nodes_data_from_api(url, is_test_run<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Return sewer nodes data as GeoJSON.</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="co">    In test runs, limit the number of API requests made."""</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    data_entries <span class="op">=</span> request_sewer_nodes_data_from_api(url, is_test_run)</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>    geojson_data <span class="op">=</span> parse_sewer_node_results(data_entries)</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> geojson_data</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> request_sewer_nodes_data_from_api(url, is_test_run<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Retrieve all sewer node results from API.</span></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="co">    For test runs, stop after first 3 pages of results."""</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>    api_response <span class="op">=</span> requests.get(url, headers<span class="op">=</span>{<span class="st">'User-Agent'</span>: <span class="st">'data1'</span>}).json()</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>    sewer_node_entries <span class="op">=</span> []</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    num_pages_requested <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> api_response <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="fl">0.5</span>)  <span class="co"># avoid spamming server</span></span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> api_response[<span class="st">"_embedded"</span>][<span class="st">"waternet_rioolknopen"</span>]</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>        sewer_node_entries <span class="op">+=</span> data</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">"next"</span> <span class="kw">in</span> api_response[<span class="st">"_links"</span>]:  <span class="co"># has next page of results</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>            api_response <span class="op">=</span> requests.get(api_response[<span class="st">"_links"</span>][<span class="st">"next"</span>][<span class="st">"href"</span>],</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>                                        headers<span class="op">=</span>{<span class="st">'User-Agent'</span>: <span class="st">'data1'</span>}).json()</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:  <span class="co"># is last page of results</span></span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>            api_response <span class="op">=</span> <span class="va">None</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>        num_pages_requested <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> is_test_run <span class="kw">and</span> num_pages_requested <span class="op">&gt;=</span> <span class="dv">3</span>:</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span></span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> sewer_node_entries</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> parse_sewer_node_results(sewer_node_entries):</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Parse sewer node results from Amsterdam sewer network API to GeoJSON"""</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>    transformer <span class="op">=</span> Transformer.from_crs(<span class="st">"EPSG:7415"</span>, <span class="st">"EPSG:4326"</span>)</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>    geojson <span class="op">=</span> {</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type"</span>: <span class="st">"FeatureCollection"</span>,</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features"</span>: []</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> entry <span class="kw">in</span> sewer_node_entries:</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>        x, y, z <span class="op">=</span> entry[<span class="st">"geometrie"</span>][<span class="st">"coordinates"</span>]</span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>        lat, lon <span class="op">=</span> transformer.transform(x, y)</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>        feature <span class="op">=</span> {</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>            <span class="st">"type"</span>: <span class="st">"Feature"</span>,</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>            <span class="st">"geometry"</span>: {</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>                <span class="st">"type"</span>: <span class="st">"Point"</span>,</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>                <span class="st">"coordinates"</span>: [lon, lat]</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>            <span class="st">"properties"</span>: {</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>                <span class="st">"id"</span>: entry[<span class="st">"id"</span>],</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>                <span class="st">"typeKnoop"</span>: entry[<span class="st">"typeKnoop"</span>]</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>        geojson[<span class="st">"features"</span>].append(feature)</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> geojson</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_sewage_overflow_nodes(url,</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>                              sewer_nodes_filename,</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>                              sewage_overflow_nodes_filename,</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>                              is_test_run):</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Return sewage overflow points as geodataframe read from the</span></span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a><span class="co">    GeoJSON file. If file does not exist, get and process the sewer nodes data,</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a><span class="co">     then save results to the GeoJSON file.</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a><span class="co">        url: API endpoint for sewage networks data</span></span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a><span class="co">        sewer_nodes_filename: name of GeoJSON file containing (or will contain)</span></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a><span class="co">                              the saved sewer nodes data</span></span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a><span class="co">        sewage_overflow_nodes_filename: name of GeoJSON file containing</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a><span class="co">                                        (or that will contain) the saved</span></span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a><span class="co">                                        sewage overflow nodes data</span></span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a><span class="co">        is_test_run: if True, limit number of API requests made (for debugging)</span></span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> os.path.exists(sewage_overflow_nodes_filename):</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Sewage overflow nodes data already exists in file '</span><span class="sc">{}</span><span class="st">'"</span></span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>              .<span class="bu">format</span>(sewage_overflow_nodes_filename))</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>        gdf_overflows <span class="op">=</span> gpd.read_file(sewage_overflow_nodes_filename)</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>        gdf_sewer_nodes <span class="op">=</span> get_sewer_nodes(url, sewer_nodes_filename,</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>                                          is_test_run)</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>        gdf_overflows <span class="op">=</span> gdf_sewer_nodes[gdf_sewer_nodes[<span class="st">"typeKnoop"</span>]</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>                                        .isin(SEWAGE_OVERFLOW_TYPES)]</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>        gdf_overflows.to_file(sewage_overflow_nodes_filename)</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Sewage overflow nodes data saved to file '</span><span class="sc">{}</span><span class="st">'"</span></span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>              .<span class="bu">format</span>(sewage_overflow_nodes_filename))</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gdf_overflows</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>pgdf_overflows <span class="op">=</span> get_sewage_overflow_nodes(</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>    URL_SEWER_NODES, FILENAME_SEWER_NODES, FILENAME_SEWAGE_OVERFLOW_NODES,</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>    is_test_run<span class="op">=</span><span class="va">False</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We then plot the sewage overflow points on a map.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>map_of_sewage_overflow_nodes <span class="op">=</span> pgdf_overflows.explore(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    legend<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"Sewage Overflow Points"</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>folium.TileLayer(<span class="st">"CartoDB positron"</span>, show<span class="op">=</span><span class="va">False</span>).add_to(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    map_of_sewage_overflow_nodes</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>map_of_sewage_overflow_nodes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Observe that there are fewer sewage overflow points in the northeast area of Amsterdam’s canals, near Marineterrein. Assuming water pollution dissipates quickly with distance from the sewage overflow point, we can choose a route that avoids most of the sewer nodes to ensure better water quality for the swim.</p>
</section>
<section id="canal-traffic" class="level3">
<h3 class="anchored" data-anchor-id="canal-traffic">Canal Traffic</h3>
<p>Boat traffic is another source of water pollution. Due to the lack of exhaust gas treatment systems in boat engines, as found in all modern car engines, a modern 5 horsepower 4-stroke outboard engine can be as polluting as 39 passenger cars driving at 95 km/h. <span class="citation" data-cites="propel_why_2022">(<a href="#ref-propel_why_2022" role="doc-biblioref">Propel 2022</a>)</span> As of 2020, there are about 12 550 boats in the canals of Amsterdam, approximately 550 of which are commercial boats, the remaining 12000 are recreational boats. Of the commercial fleet about 75% is emission free, while for recreational boats this percentage is only 5%. <span class="citation" data-cites="sterling_amsterdams_2020">(<a href="#ref-sterling_amsterdams_2020" role="doc-biblioref">Sterling 2020</a>)</span></p>
<p>While we do not know the detailed relationship between boat traffic and water quality, we do know that water toxicity as a result of fossil fuelled boats can stay present up to 14 days after the use of boats <span class="citation" data-cites="JUTTNER19951976">(<a href="#ref-JUTTNER19951976" role="doc-biblioref">Jüttner et al. 1995</a>)</span>. Thus, one possibility is to limit the number of fossil fuelled boats in the two weeks prior to the event.</p>
</section>
</section>
<section id="choosing-a-route" class="level2">
<h2 class="anchored" data-anchor-id="choosing-a-route">Choosing a route</h2>
<p>Since the Amsterdam City Swim is held annually in the canals, this suggests that an open water swim is feasible. However, we will need to find a suitable 5km route. We have been told to ensure that the event does not impact commercial water transport, and has a small impact on the canal boat routes.</p>
<section id="canal-traffic-1" class="level3">
<h3 class="anchored" data-anchor-id="canal-traffic-1">Canal traffic</h3>
<p>To minimise impact on boat routes, we look for a route that avoids areas of high canal traffic. This would also result in a route with cleaner water.</p>
<p>Waternet commissioned TNO to produce a model to predict traffic densities in the canal. <span class="citation" data-cites="snelder_op_2013">(<a href="#ref-snelder_op_2013" role="doc-biblioref">Snelder, Minderhoud, and Calvert 2013</a>)</span> The prediction results from the model are as follows (image only, as we do not have access to the raw data):</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Ams Canal Speeds-Layout1-06.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">image</figcaption>
</figure>
</div>
</section>
<section id="amsterdam-city-swim" class="level3">
<h3 class="anchored" data-anchor-id="amsterdam-city-swim">Amsterdam City Swim</h3>
<p>We take reference from the Amsterdam City Swim, which is held every summer in the canals of Amsterdam. We have the routes for 2019 and 2023, both of which are the same, other than the direction.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Ams Canal Speeds-Layout1-09.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Amsterdam City Swim 2019 route</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Ams Canal Speeds-Layout1-11.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Amsterdam City Swim 2023 route</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Ams Canal Speeds-Layout1-12.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Amsterdam City Swim 2019 &amp; 2023 routes</figcaption>
</figure>
</div>
</section>
<section id="identifying-potential-routes" class="level3">
<h3 class="anchored" data-anchor-id="identifying-potential-routes">Identifying potential routes</h3>
<p>Based on the City Swims, Amsterdam Oost seems to be a suitable area for open water swimming events. Visual comparison also shows that Amsterdam Oost has relatively fewer sewage overflow points and less canal traffic.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Ams Canal Speeds-Layout1-13.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Amsterdam Oost</figcaption>
</figure>
</div>
<p>Thus, we have identified 3 potential 5km routes in this area, indicated in the images below. Our recommendation is the third route, as it traverses the fewest number of sewage overflow points.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Ams Canal Speeds-Layout1-14.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Route 1</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Ams Canal Speeds-Layout1-15.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Route 2</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Ams Canal Speeds-Layout1-16.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Route 3</figcaption>
</figure>
</div>
</section>
</section>
<section id="recommendations" class="level2">
<h2 class="anchored" data-anchor-id="recommendations">Recommendations</h2>
<p>We propose the following route, which traverses the fewest number of sewage overflow nodes and avoids areas with high traffic.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/Ams Canal Speeds-Layout1-16.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Route 3</figcaption>
</figure>
</div>
<p>However, since Waternet recommends people to avoid swimming in the waters for 3 days after heavy rainfall <span class="citation" data-cites="waternet_swimming_nodate">(<a href="#ref-waternet_swimming_nodate" role="doc-biblioref">Waternet n.d.</a>)</span>, we would recommend finding an alternative backup route in case there is heavy rainfall prior to the event. It would also be better for water quality should fossil fuelled boats be banned from the area for two weeks before the event, though this may not be economically feasible.</p>
</section>
<section id="auto-generated-routes" class="level2">
<h2 class="anchored" data-anchor-id="auto-generated-routes">Auto-generated routes</h2>
<p>After selecting a route manually, we also prepared a script to automatically identify potential routes for the swim. This appendix describes the process, as well as a comparison between the routes found manually and automatically.</p>
<section id="finding-potential-routes" class="level3">
<h3 class="anchored" data-anchor-id="finding-potential-routes">Finding potential routes</h3>
<p>Here is the list of <strong>datasets</strong> we have identified, along with the <strong>relevant available sources</strong> and their <strong>formats</strong>.</p>
<table class="table">
<colgroup>
<col style="width: 5%">
<col style="width: 20%">
<col style="width: 40%">
<col style="width: 15%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">#</th>
<th style="text-align: left;">Parameter</th>
<th style="text-align: left;">Explanation</th>
<th style="text-align: left;">Source</th>
<th style="text-align: left;">Format</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1.</td>
<td style="text-align: left;">Sewage overflows</td>
<td style="text-align: left;">Used Python script to convert file to Geojson.</td>
<td style="text-align: left;"><a href="https://data.overheid.nl/dataset/xnhveaeyheww2w#panel-resources">Dataset</a></td>
<td style="text-align: left;">JSON</td>
</tr>
<tr class="even">
<td style="text-align: left;">6.</td>
<td style="text-align: left;">Embarkation and disembarkation points</td>
<td style="text-align: left;">Proxy for canal traffic</td>
<td style="text-align: left;"><a href="https://maps.amsterdam.nl/open_geodata/?k=418">Dataset</a></td>
<td style="text-align: left;">GeoJSON</td>
</tr>
</tbody>
</table>
<p>Steps:</p>
<ol type="1">
<li>Create the network of potential canals in Amsterdam, excluding canals with high shipping traffic.</li>
<li>For each waterway (excluding canals with high shipping traffic), count the number of embarkation/disembarkation points and sewage overflow points that lie nearby.</li>
<li>Find all possible 5 km routes starting from the Marineterreine swimming area, keeping track of the number of embarkation/disembarkation points and sewage overflow points for each route.</li>
<li>Sort the 5 km routes by the number of embarkation/disembarkation points, then by the number of sewage overflow points.</li>
<li>Plot the top 10 routes on a map for comparison.</li>
</ol>
<section id="create-network-of-traversable-canals-for-the-open-swim-meet" class="level4">
<h4 class="anchored" data-anchor-id="create-network-of-traversable-canals-for-the-open-swim-meet">Create network of traversable canals for the open swim meet</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> osmnx <span class="im">as</span> ox</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Import canals of Amsterdam, excluding waterways with high shipping traffic</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>ams_canals <span class="op">=</span> ox.graph_from_place(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Amsterdam, Netherlands'</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    custom_filter<span class="op">=</span>(<span class="st">'["waterway"~"canal|river|ditch"]'</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'["name"!~"IJ|Noordzeekanaal|Amsterdam-Rijnkanaal"]'</span>))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>ox.graph_to_gdfs(ams_canals, nodes<span class="op">=</span><span class="va">False</span>).explore()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="count-number-of-points-of-interest-that-lie-near-each-waterway" class="level4">
<h4 class="anchored" data-anchor-id="count-number-of-points-of-interest-that-lie-near-each-waterway">Count number of points of interest that lie near each waterway</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> count_points_close_to_lines(lines, points, buffer_dist, counts_label):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Count the number of points that lie within buffer area of each line"""</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Based on code from https://stackoverflow.com/a/54128782</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    lines_with_counts <span class="op">=</span> lines.copy()</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    spatial_index <span class="op">=</span> points.sindex</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    results_list <span class="op">=</span> []</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> index, line <span class="kw">in</span> lines.iterrows():</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">buffer</span> <span class="op">=</span> line[<span class="st">'geometry'</span>].<span class="bu">buffer</span>(buffer_dist)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find approximate matches with r-tree,</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        possible_matches_index <span class="op">=</span> <span class="bu">list</span>(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>            spatial_index.intersection(<span class="bu">buffer</span>.bounds))</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>        possible_matches <span class="op">=</span> points.iloc[possible_matches_index]</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># then use the results to find precise matches</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        precise_matches <span class="op">=</span> possible_matches[possible_matches.intersects(<span class="bu">buffer</span>)]</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        results_list.append(<span class="bu">len</span>(precise_matches))</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    lines_with_counts[counts_label] <span class="op">=</span> results_list</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> lines_with_counts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>gdf_overflows <span class="op">=</span> gpd.read_file(<span class="st">"./data/sewage_overflow_nodes.geojson"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>gdf_embarks <span class="op">=</span> gpd.read_file(<span class="st">"./data/disembarking_points.json"</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Project geometries so distances are in meters</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>proj_ams_canals <span class="op">=</span> ox.project_graph(ams_canals)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>pgdf_ams_canals <span class="op">=</span> ox.graph_to_gdfs(proj_ams_canals, nodes<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>pgdf_overflows <span class="op">=</span> ox.projection.project_gdf(gdf_overflows,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>                                           to_crs<span class="op">=</span>proj_ams_canals.graph[<span class="st">'crs'</span>])</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>pgdf_embarks <span class="op">=</span> ox.projection.project_gdf(gdf_embarks,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                                         to_crs<span class="op">=</span>proj_ams_canals.graph[<span class="st">'crs'</span>])</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>gdf_ams_canals_w_counts <span class="op">=</span> count_points_close_to_lines(pgdf_ams_canals,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>                                                      pgdf_overflows,</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>                                                      <span class="dv">65</span>,</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>                                                      <span class="st">'num_overflows'</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>gdf_ams_canals_w_counts <span class="op">=</span> count_points_close_to_lines(gdf_ams_canals_w_counts,</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>                                                      pgdf_embarks,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>                                                      <span class="dv">65</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>                                                      <span class="st">'num_embarks'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<details>
<summary>View no. of overflow points for each canal</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We use this map to visually check if the buffer distance is reasonable.</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>map_ams_canals_overflows <span class="op">=</span> gdf_ams_canals_w_counts.explore(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">'num_overflows'</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">'viridis_r'</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    tiles<span class="op">=</span><span class="st">"CartoDB positron"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>pgdf_overflows.explore(m<span class="op">=</span>map_ams_canals_overflows, style_kwds<span class="op">=</span>{<span class="st">"opacity"</span>: <span class="fl">0.5</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>View no. of embarkation points for each canal</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>map_ams_canals_embarks <span class="op">=</span> gdf_ams_canals_w_counts.explore(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    column<span class="op">=</span><span class="st">'num_embarks'</span>, cmap<span class="op">=</span><span class="st">'viridis_r'</span>, tiles<span class="op">=</span><span class="st">"CartoDB positron"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>pgdf_embarks.explore(m<span class="op">=</span>map_ams_canals_embarks, style_kwds<span class="op">=</span>{<span class="st">"opacity"</span>: <span class="fl">0.5</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="find-5km-routes-and-score-each-route" class="level4">
<h4 class="anchored" data-anchor-id="find-5km-routes-and-score-each-route">Find 5km routes and score each route</h4>
<p>For simplicity, we find the shortest path that is at least 5 km long instead of finding paths that are exactly 5 km long. To get the exact length, we will need to create a new node at the required location and split edges accordingly, which is more complicated.</p>
<p>Note that this means the scores computed for each route may not be accurate. For example, routes which are much longer than 5km due to the last edge being very long might have many overflow points from the excess part of the route.</p>
<p>While finding the routes, we also compute the scores for each route. Any column name in the geodataframe <code>gdf_with_scores</code> (that contains numeric values) can be used for scoring. The score of a route is the sum of its values for all edges in the route.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_routes_of_length_w_scores(start_node, graph, length,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                                   score_names, gdf_with_scores):</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Finds all (shortest possible) routes that are at least the</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">    specified length.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">        start_node: start node of routes</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">        graph: nx graph for finding paths</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">        length: min length of route</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">        score_names: list of column names in gdf_with_scores.</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">                     The values for edges in the route will be summed</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">                     to obtain a score for the route.</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">        gdf_with_scores: dataframe containing scores for each edge</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">        (routes, scores): list of routes, where a route is a list of</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">                          traversed edges, and</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">                          list of scores, containing one score for</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co">                          each score name</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    invalid_score_names <span class="op">=</span> <span class="bu">list</span>(<span class="bu">filter</span>(<span class="kw">lambda</span> x:</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>                                      x <span class="kw">not</span> <span class="kw">in</span> gdf_with_scores.columns,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>                                      score_names))</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(invalid_score_names) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">"Score name(s) missing from gdf_with_scores: </span><span class="sc">{}</span><span class="st">"</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>                        .<span class="bu">format</span>(<span class="st">", "</span>.join(invalid_score_names)))</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> find_routes_containing_path(curr_node, curr_path,</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>                                    curr_length, curr_weights, graph):</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> curr_length <span class="op">&gt;</span> length:  <span class="co"># found valid route</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> [curr_path], [curr_weights]</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        traversed_nodes <span class="op">=</span> [edge[<span class="dv">0</span>] <span class="cf">for</span> edge <span class="kw">in</span> curr_path] <span class="op">+</span> [curr_node]</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        prev_node <span class="op">=</span> curr_path[<span class="op">-</span><span class="dv">1</span>][<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">len</span>(curr_path) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>        incident_edges <span class="op">=</span> graph.edges(curr_node, keys<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        routes_containing_curr_path <span class="op">=</span> []</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        route_scores <span class="op">=</span> []</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> edge <span class="kw">in</span> incident_edges:</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> edge[<span class="dv">1</span>] <span class="kw">in</span> traversed_nodes:  <span class="co"># avoid loops</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>            new_path <span class="op">=</span> curr_path <span class="op">+</span> [edge]</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>            edge_length <span class="op">=</span> graph.edges[edge][<span class="st">"length"</span>]</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>            edge_data <span class="op">=</span> gdf_with_scores.loc[edge]</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>            new_weights <span class="op">=</span> [curr_weights[i] <span class="op">+</span> edge_data[score_name]</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>                           <span class="cf">for</span> i, score_name <span class="kw">in</span> <span class="bu">enumerate</span>(score_names)]</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>            routes_with_new_node, scores <span class="op">=</span> find_routes_containing_path(</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>                edge[<span class="dv">1</span>],</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>                new_path,</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>                curr_length <span class="op">+</span> edge_length,</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>                new_weights, graph)</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>            routes_containing_curr_path.extend(routes_with_new_node)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>            route_scores.extend(scores)</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> routes_containing_curr_path, route_scores</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> find_routes_containing_path(start_node, [], <span class="dv">0</span>,</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>                                       [<span class="dv">0</span> <span class="cf">for</span> x <span class="kw">in</span> score_names], graph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We find all routes of length at least 5 km, and score using the number of sewage overflow nodes and number of embarkation/disembarkation points along the route.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use Marineterrein pool as start point</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>lat, lon <span class="op">=</span> <span class="fl">52.37343358243731</span>, <span class="fl">4.916215248650945</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>start_node <span class="op">=</span> ox.distance.nearest_nodes(ams_canals, lon, lat, return_dist<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>routes, scores <span class="op">=</span> find_routes_of_length_w_scores(start_node, ams_canals, <span class="dv">5000</span>,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                                                [<span class="st">'num_overflows'</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                                                 <span class="st">'num_embarks'</span>],</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                                                gdf_ams_canals_w_counts)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Found </span><span class="sc">{}</span><span class="st"> routes."</span>.<span class="bu">format</span>(<span class="bu">len</span>(routes)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we rank the routes by number of embarkation/disembarkation points, then by number of sewage overflow nodes. We prioritise impact on canal traffic over sewage overflows, as sewage overflows are a risk only in heavy downpour.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>df_scored_routes <span class="op">=</span> pd.DataFrame({</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'id'</span>: <span class="bu">range</span>(<span class="bu">len</span>(routes)),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'edge_list'</span>: routes,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'num_embarks'</span>: [score[<span class="dv">1</span>] <span class="cf">for</span> score <span class="kw">in</span> scores],</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'num_overflows'</span>: [score[<span class="dv">0</span>] <span class="cf">for</span> score <span class="kw">in</span> scores],</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>ranked_routes <span class="op">=</span> df_scored_routes.sort_values([<span class="st">'num_embarks'</span>, <span class="st">'num_overflows'</span>])</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>top_route_ids <span class="op">=</span> ranked_routes[<span class="st">'id'</span>].tolist()[<span class="dv">0</span>:<span class="dv">10</span>]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>ranked_routes[<span class="dv">0</span>:<span class="dv">10</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we plot the routes on the map.</p>
<div class="cell">
<details>
<summary>Plot top 10 routes on map</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># workaround, otherwise calling folium.plugins directly gives an error</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> folium.plugins <span class="im">as</span> plugins</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> edge_list_to_gdf(graph, edge_list):</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    node_list <span class="op">=</span> [x <span class="cf">for</span> (x, y, k) <span class="kw">in</span> edge_list]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    node_list.append(edge_list[<span class="op">-</span><span class="dv">1</span>][<span class="dv">1</span>])</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ox.utils_graph.graph_to_gdfs(</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>        graph.subgraph(node_list), nodes<span class="op">=</span><span class="va">False</span>).loc[edge_list]</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>gdf_routes <span class="op">=</span> [edge_list_to_gdf(ams_canals, routes[<span class="bu">id</span>]) <span class="cf">for</span> <span class="bu">id</span> <span class="kw">in</span> top_route_ids]</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>complete_map <span class="op">=</span> folium.Map(tiles<span class="op">=</span><span class="st">"cartodbpositron"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                          location<span class="op">=</span>(lat, lon),</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                          zoom_start<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">min</span>(<span class="dv">10</span>, <span class="bu">len</span>(gdf_routes))):</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    folium.GeoJson(</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        gdf_routes[i].to_json(),</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"Route </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(i <span class="op">+</span> <span class="dv">1</span>),</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        style_function<span class="op">=</span><span class="kw">lambda</span> feature: {</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>            <span class="st">"weight"</span>: <span class="dv">3</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">"opacity"</span>: <span class="fl">0.3</span>,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>            <span class="st">"color"</span>: <span class="st">"#1AC938"</span>,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>        show<span class="op">=</span>(i <span class="op">&lt;</span> <span class="dv">1</span>)</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        ).add_to(complete_map)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot points as circles, see https://stackoverflow.com/a/65836395</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>folium.GeoJson(gdf_embarks.to_json(),</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>               marker<span class="op">=</span>folium.CircleMarker(radius<span class="op">=</span><span class="dv">3</span>,  <span class="co"># in meters</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>                                          weight<span class="op">=</span><span class="dv">0</span>,  <span class="co"># outline</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>                                          fill_color<span class="op">=</span><span class="st">"#023EFF"</span>,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>                                          fill_opacity<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>               name<span class="op">=</span><span class="st">"Embarkation points"</span>).add_to(complete_map)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>folium.GeoJson(gdf_overflows.to_json(),</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>               marker<span class="op">=</span>folium.CircleMarker(radius<span class="op">=</span><span class="dv">3</span>,</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>                                          weight<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>                                          fill_color<span class="op">=</span><span class="st">"#FF7C00"</span>,</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>                                          fill_opacity<span class="op">=</span><span class="fl">0.7</span>),</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>               name<span class="op">=</span><span class="st">"Sewage overflow points"</span>).add_to(complete_map)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>folium.LayerControl().add_to(complete_map)</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>complete_map</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="analysis" class="level3">
<h3 class="anchored" data-anchor-id="analysis">Analysis</h3>
<section id="generated-routes-go-north-manually-selected-routes-go-south" class="level5">
<h5 class="anchored" data-anchor-id="generated-routes-go-north-manually-selected-routes-go-south">Generated routes go north; manually selected routes go south</h5>
<p>It is interesting to note that all the top ten routes went northwards, as opposed to our three routes which went southwards.</p>
<table class="table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th><img src="images/routes-comparison.png" class="img-fluid" alt="Auto routes"></th>
<th><img src="images/Ams Canal Speeds-Layout1-14.jpg" class="img-fluid" alt="Route 1"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><img src="images/Ams Canal Speeds-Layout1-15.jpg" class="img-fluid" alt="Route 2"></td>
<td><img src="images/Ams Canal Speeds-Layout1-16.jpg" class="img-fluid" alt="Route 3"></td>
</tr>
</tbody>
</table>
<p>While we did use embarkation/disembarkation points instead of canal traffic data, the northern route has a traffic density of 0%, so the northern route seems to be a better choice in terms of having fewer sewage overflow points and also smaller impact on canal traffic.</p>
<p>However, the available datasets consider only a limited number of factors. While we did not explicitly state this, the reason we avoided the northern route was because it goes through an area of Marineterrein which is contaminated by oil, heavy metals, tar-like substances and PAHs <span class="citation" data-cites="vijsel_het_2012">(<a href="#ref-vijsel_het_2012" role="doc-biblioref">Vijsel 2012</a>)</span>. This has a critical impact on the water quality, yet is not captured by the datasets.</p>
<p>Furthermore, while selecting our routes, we took reference from the Amsterdam City Swim route, since the organizers would have considered other factors that we might have missed out on.</p>
</section>
<section id="unexpected-results-highlight-implicit-assumptions-and-expectations" class="level4">
<h4 class="anchored" data-anchor-id="unexpected-results-highlight-implicit-assumptions-and-expectations">Unexpected results highlight implicit assumptions and expectations</h4>
<p>Code considers only what is stated; humans use context and background knowledge. The automatically generated routes did not match our manually generated routes even though we seemed to be considering the same factors, because we considered other factors in our selection that we may not even be explicitly aware of.</p>
<p>For example, the code originally allowed for loops in the routes (allow nodes to be visited twice), so that we could obtain routes similar to our third proposed route. However, this resulted in counter-intuitive routes that seem less pleasant and harder to manage, such as the below route.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/unintuitive-routes.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Route 3</figcaption>
</figure>
</div>
<p>As such, we disallowed loops instead. This also reduced time required since the search space is smaller. However, we may miss out some feasible routes.</p>
</section>
<section id="constraints-imposed-by-the-dataset" class="level4">
<h4 class="anchored" data-anchor-id="constraints-imposed-by-the-dataset">Constraints imposed by the dataset</h4>
<p>Besides the limitations mentioned in previous sections, the structure of the network also constrains the possible routes. For example, the lake in Sloterplas is represented using a single line, which rules out the possibly of swimming around the circumference of the lake.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/sloterplas.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Sloterplas waterway</figcaption>
</figure>
</div>
</section>
</section>
<section id="conclusion" class="level3">
<h3 class="anchored" data-anchor-id="conclusion">Conclusion</h3>
<p>Using a program to find routes allowed us to search more comprehensively in less time. However, the program is constrained by the assumptions built into the code, as well as the provided datasets. We often consider multiple factors in our decisions, without necessarily being aware of those factors. Automating the process made our assumptions and considerations much more explicit.</p>
<p>Given more time and resources, we would use these identified gaps as a guide to look for more data. Through repeated iterations, we can hopefully find a solution that humans may miss out (since we are less thorough), but that considers the broad set of factors that we use.</p>
<p>Nonetheless, data can be hard to collect and datasets hard to find, and not all intuitions can be easily made explicit. Perhaps this is where machine learning combined with human judgement can take us further.</p>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-JUTTNER19951976" class="csl-entry" role="listitem">
Jüttner, Friedrich, Diedrich Backhaus, Uwe Matthias, Ulf Essers, Rolf Greiner, and Bernd Mahr. 1995. <span>“Emissions of Two- and Four-Stroke Outboard Engines—i. Quantification of Gases and VOC.”</span> <em>Water Research</em> 29 (8): 1976–82. https://doi.org/<a href="https://doi.org/10.1016/0043-1354(94)00330-A">https://doi.org/10.1016/0043-1354(94)00330-A</a>.
</div>
<div id="ref-propel_why_2022" class="csl-entry" role="listitem">
Propel. 2022. <span>“Why <span>Amsterdam</span> Is a Perfect Example of Cities Going Carbon-Neutral.”</span> <em>Why Amsterdam Is a Perfect Example of Cities Going Carbon-Neutral</em>. <a href="https://propel.me/nl/article/why-amsterdam-is-a-perfect-example-of-cities-going-carbon-neutral/">https://propel.me/nl/article/why-amsterdam-is-a-perfect-example-of-cities-going-carbon-neutral/</a>.
</div>
<div id="ref-snelder_op_2013" class="csl-entry" role="listitem">
Snelder, Maaike, Michiel Minderhoud, and Simeon Calvert. 2013. <span>“Op de <span>Amsterdamse</span> Grachten, Hebben Wij Nu de Drukte in de Hand, <span>Amsterdam</span> ...”</span> November.
</div>
<div id="ref-sterling_amsterdams_2020" class="csl-entry" role="listitem">
Sterling, Toby. 2020. <span>“Amsterdam’s Boats Go Electric Ahead of 2025 Diesel Ban.”</span> <em>Reuters</em>, March. <a href="https://www.reuters.com/article/us-climate-change-netherlands-idUSKBN20Q1W7">https://www.reuters.com/article/us-climate-change-netherlands-idUSKBN20Q1W7</a>.
</div>
<div id="ref-van_den_tillaart_swim_2017" class="csl-entry" role="listitem">
Tillaart, Amber van den. 2017. <span>“(<span>Swim</span>) Water Quality Modelling in the City of <span>Amsterdam</span>,”</span> February.
</div>
<div id="ref-vijsel_het_2012" class="csl-entry" role="listitem">
Vijsel, Annemarie van de. 2012. <span>“Het Marineterrein: Verontreinigde Toplocatie.”</span> <em>Nieuw Amsterdams Peil</em>. <a href="https://www.napnieuws.nl/2012/11/08/het-marineterrein-een-verontreinigde-toplocatie/">https://www.napnieuws.nl/2012/11/08/het-marineterrein-een-verontreinigde-toplocatie/</a>.
</div>
<div id="ref-waternet_swimming_nodate" class="csl-entry" role="listitem">
Waternet. n.d. <span>“Swimming.”</span> Accessed October 14, 2023. <a href="https://www.waternet.nl/en/our-water/safe-swimming/">https://www.waternet.nl/en/our-water/safe-swimming/</a>.
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>